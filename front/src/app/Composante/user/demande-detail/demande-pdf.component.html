<div #pdfContent class="pdf-container">
  <div *ngIf="demande" class="pdf-content">
    <!-- En-tête PDF -->
    <div class="pdf-header">
      <div class="pdf-logo">
        <img src="/images/salafan.jpg" alt="Logo Salafa" *ngIf="hasLogo">
        <div class="entreprise-info" *ngIf="!hasLogo">
          <h2>SALAFA</h2>
          <p>Adresse · Téléphone · Email</p>
        </div>
      </div>

      <div class="pdf-title">
        <h1>
          {{ demande.type === 'DED' ? "DEMANDE D'ENGAGEMENT DE DEPENSES (DED)" :
              demande.type === 'Recette' ? "DEMANDE DE RECETTE" : "DEMANDE ERD" }}
        </h1>
        <div class="pdf-reference">
          <strong>Référence:</strong> {{ getDemandeReference() }}
        </div>
      </div>
    </div>

    <!-- Informations demande -->
    <div class="demande-header">
      <div class="demande-info-grid">
        <div class="info-item">
          <label>Date:</label>
          <span>{{ demande.date | date:'dd/MM/yyyy' }}</span>
        </div>
        <div class="info-item">
          <label>Demandeur:</label>
          <span>{{ demande.responsible_pj?.prenom }} {{ demande.responsible_pj?.nom }}</span>
        </div>
          <div class="info-item" *ngIf="demande.journal">
            <label>Journal:</label>
            <span>{{ demande.journal.nom_journal }} ({{ demande.journal.nom_projet }}) - Numéro: {{ demande.numero_approuve_journal }}</span>
          </div>
        <div class="info-item">
          <label>Pièces Jointes:</label>
          <span class="pj-badge" [ngClass]="{'pj-oui': demande.pj_status === 'oui', 'pj-non': demande.pj_status !== 'oui'}">
            {{ demande.pj_status === 'oui' ? '✓ Disponibles' : '✗ Manquantes' }}
          </span>
        </div>
        <div class="info-item full-width">
          <label>Motif:</label>
          <span class="motif-text">{{ demande.description }}</span>
        </div>
      </div>
    </div>

    <!-- Tableau des détails -->
    <div class="demande-details">
      <div class="table-container">
        <table class="details-table">
          <thead>
            <tr>
              <th width="15%">Bénéficiaire</th>
              <th width="25%">Libellé</th>
              <th width="20%">Code Budget</th>
              <th width="10%">NIF/STAT</th>
              <th width="10%">N° Compte</th>
              <th width="10%" class="text-left">Débit</th>
              <th width="10%" class="text-left">Crédit</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let detail of demande.details; let i = index">
              <td class="beneficiaire">{{ detail.beneficiaire }}</td>
              <td class="libelle">{{ detail.libelle }}</td>

              <td class="code-budget-cell">
                <div class="budget-info">
                  <span class="budget-code">{{ detail.budget?.code_budget || '-' }}</span>
                  <span class="budget-desc" *ngIf="detail.budget">{{ detail.budget.description }}</span>
                </div>
              </td>

              <td class="fiscal-info">
                <div *ngIf="detail.nif" class="nif-stat">NIF: {{ detail.nif }}</div>
                <div *ngIf="detail.stat" class="nif-stat">STAT: {{ detail.stat }}</div>
              </td>

              <td class="compte-number">
                {{ detail.numero_compte || '-' }}
              </td>

              <td class="amount text-left">
                <span *ngIf="demande.type === 'DED' || (demande.type === 'ERD' && i > 0)"
                      class="debit-amount">
                  {{ detail.amount | number:'1.2-2' }}
                </span>
                <span *ngIf="!(demande.type === 'DED' || (demande.type === 'ERD' && i > 0))" class="no-amount">
                  -
                </span>
              </td>

              <td class="amount text-left">
                <span *ngIf="demande.type === 'Recette' || (demande.type === 'ERD' && i === 0)"
                      class="credit-amount">
                  {{ detail.amount | number:'1.2-2' }}
                </span>
                <span *ngIf="!(demande.type === 'Recette' || (demande.type === 'ERD' && i === 0))" class="no-amount">
                  -
                </span>
              </td>
            </tr>

            <!-- Ligne de séparation -->
            <tr class="separator">
              <td colspan="7"></td>
            </tr>

            <!-- Totaux -->
            <tr class="totals-row">
              <td colspan="5" class="text-right totals-label">
                TOTAUX:
              </td>
              <td class="text-left total-amount">
                <strong>{{ totalDebit | number:'1.2-2' }}</strong>
              </td>
              <td class="text-left total-amount">
                <strong>{{ totalCredit | number:'1.2-2' }}</strong>
              </td>
            </tr>

            <!-- Solde -->
            <tr class="solde-row">
              <td colspan="5" class="text-right solde-label">
                SOLDE (Débit - Crédit):
              </td>

              <td class="text-left solde-amount" [ngClass]="{'negative': solde < 0}">
                <strong *ngIf="solde < 0">{{ (solde * -1) | number:'1.2-2' }}</strong>
                <span *ngIf="solde >= 0" class="no-amount">-</span>
              </td>

              <td class="text-left solde-amount" [ngClass]="{'positive': solde > 0}">
                <strong *ngIf="solde > 0">{{ solde | number:'1.2-2' }}</strong>
                <span *ngIf="solde <= 0" class="no-amount">-</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="montant-lettres">
        <strong>Arrêtée à la somme totale de:</strong> 
        <span class="montant-text">{{ montantEnLettres }} Ariary</span>
      </div>
    </div>

    <!-- Validateurs -->
    <div class="validators-section">
      <h3 class="validators-title">VALIDATIONS</h3>

      <div class="validators-grid">
        <div *ngFor="let i of [0,1,2,3]" class="validator-card">
          <ng-container *ngIf="displayValidators[i] && displayValidators[i].user_id > 0">
            <div class="validator-header">
              <h4>{{ displayValidators[i].user?.username || 'Validateur' }}</h4>
              <span class="validator-role" *ngIf="displayValidators[i].user?.role">{{ displayValidators[i].user?.role }}</span>
              <span class="validator-badge" [ngClass]="'status-' + displayValidators[i].statut">
                {{ displayValidators[i].statut | titlecase }}
              </span>
            </div>

            <div class="signature-container">
              <ng-container *ngIf="displayValidators[i].statut === 'validé' && displayValidators[i].signatureBase64; else placeholderSignature">
                <img [src]="displayValidators[i].signatureBase64"
                     alt="Signature de {{ displayValidators[i].user?.username }}"
                     class="signature-image">
                <p class="signature-date" *ngIf="displayValidators[i].date_validation">
                  Le {{ displayValidators[i].date_validation | date:'dd/MM/yyyy' }}
                </p>
              </ng-container>

              <ng-template #placeholderSignature>
                <div class="signature-placeholder">
                  <i class="fas fa-pen"></i>
                  <span>Signature</span>
                </div>
                <p class="signature-date">En attente</p>
              </ng-template>
            </div>
          </ng-container>

          <ng-container *ngIf="displayValidators[i] && displayValidators[i].user_id <= 0">
            <div class="validator-header">
              <!-- Empty header for placeholder -->
            </div>
            <div class="signature-container">
              <div class="signature-placeholder-empty">
                <!-- Empty frame for signature -->
              </div>
            </div>
          </ng-container>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="pdf-footer">
      <div class="footer-content">
        <div class="footer-left">
          <p>SALAFA - Adresse · Téléphone · Email</p>
        </div>
        <div class="footer-right">
          <p>Page 1/1</p>
        </div>
      </div>
    </div>
  </div>
</div>
