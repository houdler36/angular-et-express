<div class="container-vertical">

  <!-- Formulaire création / édition -->
  <div class="card form-card">
    <h3>{{ isEditMode ? 'Modifier le Journal' : 'Créer un nouveau Journal' }}</h3>
    <form (ngSubmit)="isEditMode ? updateJournal() : addJournal()">
      <div class="form-grid">
        <!-- Nom du journal -->
        <div>
          <label for="nom_journal">Nom du Journal</label>
          <input type="text" id="nom_journal" [(ngModel)]="newJournal.nom_journal" name="nom_journal" required>
        </div>

        <!-- Nom du projet -->
        <div>
          <label for="nom_projet">Nom du Projet</label>
          <input type="text" id="nom_projet" [(ngModel)]="newJournal.nom_projet" name="nom_projet" required>
        </div>

        <!-- Solde -->
        <div>
          <label for="solde">Solde</label>
          <input type="number" id="solde" [(ngModel)]="newJournal.solde" name="solde" min="0" step="0.01" required>
        </div>
      </div>

      <!-- Budgets -->
      <div>
        <label for="budgets">Budgets</label>
        <select id="budgets" multiple [(ngModel)]="selectedBudgetIds" name="budgets">
          <option *ngFor="let budget of budgetsDisponibles" [value]="budget.id_budget">{{ budget.code_budget }} - {{ budget.description }}</option>
        </select>
      </div>

      <!-- Valideurs -->
      <div>
        <label>Valideurs (ordre)</label>
        <ul>
          <li *ngFor="let valideur of valideursDisponibles"
              (click)="toggleValideur(valideur, $event)"
              [class.selected]="isValideurSelected(valideur.id)">
            {{ valideur.username }}
          </li>
        </ul>
      </div>

      <div *ngIf="selectedValideurs.length > 0">
        <strong>Ordre de validation :</strong>
        <ul>
          <li *ngFor="let item of selectedValideurs">{{ item.ordre }} - {{ getValideurName(item.user_id) }}</li>
        </ul>
      </div>

      <div class="button-group">
        <button type="submit" [disabled]="isLoading" [class.loading]="isLoading">➕ {{ isEditMode ? 'Mettre à jour' : 'Créer' }}</button>
        <button type="button" *ngIf="isEditMode" (click)="cancelEdit()">❌ Annuler</button>
      </div>
    </form>
  </div>

  <!-- Liste des journaux -->
  <div class="card table-card">
    <h3>Liste des Journaux</h3>
    <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Nom journal</th>
          <th>Nom projet</th>
          <th>Solde</th>
          <th>Budgets</th>
          <th>Valideurs</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let journal of journals">
          <td>{{ journal.id_journal }}</td>
          <td>{{ journal.nom_journal }}</td>
          <td>{{ journal.nom_projet }}</td>
          <td>{{ journal.solde | number:'1.0-0' }} Ar</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <ul class="budget-list">
              <li *ngFor="let budget of journal.budgets">
                {{ budget.code_budget }} - {{ budget.description }}
              </li>
            </ul>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <ul class="valideur-list">
              <li *ngFor="let valideur of journal.valideurs">
                {{ valideur.ordre }} - {{ valideur.username }}
              </li>
            </ul>
          </td>
          <td>
            <button (click)="editJournal(journal)" class="edit-btn action-btn" title="Modifier">📝</button>
            <button (click)="deleteJournal(journal.id_journal)" class="delete-btn action-btn" title="Supprimer">🗑️</button>
          </td>
        </tr>
      </tbody>
    </table>
    </div>
  </div>

  <!-- Modal -->
  <div *ngIf="isModalVisible" class="modal-overlay">
    <div class="modal-content">
      <span class="modal-close-btn" (click)="hideModal()">×</span>
      <div class="modal-icon" [ngClass]="{'success-icon': isSuccess, 'error-icon': !isSuccess}">
        {{ isSuccess ? '✔' : '✖' }}
      </div>
      <div class="modal-title">{{ isSuccess ? 'Succès !' : 'Erreur !' }}</div>
      <div class="modal-message">{{ modalMessage }}</div>
      <button (click)="hideModal()">OK</button>
    </div>
  </div>

</div>
