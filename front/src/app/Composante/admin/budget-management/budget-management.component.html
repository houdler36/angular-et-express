<h1>Gestion des budgets</h1>
<p>Ajoutez un nouveau budget et suivez ses montants annuels et trimestriels.</p>
<hr class="divider">

<form (ngSubmit)="addBudget()" class="form-container" #budgetForm="ngForm">
  <h2>Ajouter un nouveau budget</h2>
  <div class="form-group">
    <label for="codeBudget">Code du budget</label>
    <input id="codeBudget" type="text" [(ngModel)]="newBudget.code_budget" name="code_budget" required>
  </div>
  <div class="form-group">
    <label for="description">Description</label>
    <input id="description" type="text" [(ngModel)]="newBudget.description" name="description" required>
  </div>
  <div class="form-group">
    <label for="anneeFiscale">Année fiscale</label>
    <input id="anneeFiscale" type="number" [(ngModel)]="newBudget.annee_fiscale" name="annee_fiscale" required>
  </div>
  <div class="form-group">
    <label for="budgetAnnuel">Budget annuel</label>
    <input id="budgetAnnuel" type="number" [(ngModel)]="newBudget.budget_annuel" name="budget_annuel" required (ngModelChange)="checkBudgetValidity()">
  </div>

  <div class="trimestres-container">
    <div class="form-group">
      <label for="budget1trimestre">Budget 1er Trimestre</label>
      <input id="budget1trimestre" type="number" [(ngModel)]="newBudget.budget_trimestre_1" name="budget_trimestre_1" (ngModelChange)="checkBudgetValidity()">
    </div>
    <div class="form-group">
      <label for="budget2trimestre">Budget 2e Trimestre</label>
      <input id="budget2trimestre" type="number" [(ngModel)]="newBudget.budget_trimestre_2" name="budget_trimestre_2" (ngModelChange)="checkBudgetValidity()">
    </div>
    <div class="form-group">
      <label for="budget3trimestre">Budget 3e Trimestre</label>
      <input id="budget3trimestre" type="number" [(ngModel)]="newBudget.budget_trimestre_3" name="budget_trimestre_3" (ngModelChange)="checkBudgetValidity()">
    </div>
    <div class="form-group">
      <label for="budget4trimestre">Budget 4e Trimestre</label>
      <input id="budget4trimestre" type="number" [(ngModel)]="newBudget.budget_trimestre_4" name="budget_trimestre_4" (ngModelChange)="checkBudgetValidity()">
    </div>
  </div>

  <div *ngIf="isBudgetInvalid" class="error-message">
    La somme des budgets trimestriels ({{ sumTrimestres | number:'1.2-2' }}) ne doit pas dépasser le budget annuel ({{ newBudget.budget_annuel | number:'1.2-2' }}).
  </div>

  <button type="submit" [disabled]="!budgetForm.valid || isBudgetInvalid">Ajouter le budget</button>
</form>

<hr class="divider">

<div class="filter-container">
  <label for="yearFilter">Année : </label>
  <input id="yearFilter" type="number" [ngModel]="selectedYear" (ngModelChange)="applyFilters($event)" [placeholder]="currentYear" class="small-input">
  
  <label for="searchFilter">Recherche : </label>
  <input id="searchFilter" type="text" [(ngModel)]="searchTerm" (ngModelChange)="applyFilters()" placeholder="Code ou Description">
  
  <button (click)="toggleReste()" class="toggle-button">
    {{ showReste ? 'Voir Budget Initial' : 'Voir le Reste' }}
  </button>
</div>

<h2>Liste des budgets de l'année {{ selectedYear }}</h2>
<div class="table-container">
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Code du budget</th>
        <th>Description</th>
        <th>Année fiscale</th>
        
        <th *ngIf="!showReste">Budget annuel</th>
        <th *ngIf="showReste">Reste annuel</th>

        <th *ngIf="!showReste">Budget T1</th>
        <th *ngIf="showReste">Reste T1</th>
        
        <th *ngIf="!showReste">Budget T2</th>
        <th *ngIf="showReste">Reste T2</th>
        
        <th *ngIf="!showReste">Budget T3</th>
        <th *ngIf="showReste">Reste T3</th>
        
        <th *ngIf="!showReste">Budget T4</th>
        <th *ngIf="showReste">Reste T4</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let budget of budgetsAffiches" [ngClass]="{'alert-row-annual': budget.reste_budget <= 0 && showReste, 'warn-row-annual': budget.reste_budget > 0 && budget.reste_budget / budget.budget_annuel < 0.1 && showReste}">
        <td>{{ budget.id_budget }}</td>
        <td>{{ budget.code_budget }}</td>
        <td>{{ budget.description }}</td>
        <td>{{ budget.annee_fiscale }}</td>
        
        <td *ngIf="!showReste">{{ budget.budget_annuel | number:'1.2-2' }}</td>
        <td *ngIf="showReste" [ngClass]="{'alert-cell': budget.reste_budget <= 0}">{{ budget.reste_budget | number:'1.2-2' }}</td>

        <td *ngIf="!showReste">{{ budget.budget_trimestre_1 | number:'1.2-2' }}</td>
        <td *ngIf="showReste" [ngClass]="{'alert-cell': budget.reste_trimestre_1 <= 0}">{{ budget.reste_trimestre_1 | number:'1.2-2' }}</td>

        <td *ngIf="!showReste">{{ budget.budget_trimestre_2 | number:'1.2-2' }}</td>
        <td *ngIf="showReste" [ngClass]="{'alert-cell': budget.reste_trimestre_2 <= 0}">{{ budget.reste_trimestre_2 | number:'1.2-2' }}</td>

        <td *ngIf="!showReste">{{ budget.budget_trimestre_3 | number:'1.2-2' }}</td>
        <td *ngIf="showReste" [ngClass]="{'alert-cell': budget.reste_trimestre_3 <= 0}">{{ budget.reste_trimestre_3 | number:'1.2-2' }}</td>

        <td *ngIf="!showReste">{{ budget.budget_trimestre_4 | number:'1.2-2' }}</td>
        <td *ngIf="showReste" [ngClass]="{'alert-cell': budget.reste_trimestre_4 <= 0}">{{ budget.reste_trimestre_4 | number:'1.2-2' }}</td>
      </tr>
      <tr *ngIf="budgetsAffiches.length === 0">
        <td colspan="8" style="text-align: center;">
          Aucun budget trouvé pour l'année {{ selectedYear }} correspondant à la recherche *{{ searchTerm }}*.
        </td>
      </tr>
    </tbody>
  </table>
</div>