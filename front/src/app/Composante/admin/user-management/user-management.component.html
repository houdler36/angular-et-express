<div class="user-management">

  <!-- Message -->
  <div *ngIf="message" class="alert" [class.error]="isError" [class.success]="!isError">
    {{ message }}
  </div>

  <!-- Header avec bouton -->
  <div class="header">
    <h2>Gestion des utilisateurs</h2>
    <button class="btn-primary" (click)="openModal()">+ Ajouter un utilisateur</button>
  </div>

  <!-- Tableau des utilisateurs -->
  <table class="user-table" *ngIf="users.length > 0; else noUsers">
    <thead>
      <tr>
        <th>Nom</th>
        <th>Email</th>
        <th>Rôle</th>
        <th>Journaux</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let user of users">
        <td>{{ user.username }}</td>
        <td>{{ user.email }}</td>
        <td>{{ user.role }}</td>
        <td>{{ getJournalNamesForUser(user) }}</td>
        <td>
          <button class="action-btn edit-btn" (click)="openModal(user)">✎</button>
          <button class="action-btn delete-btn" (click)="confirmDeleteUser(user)">✖</button>
        </td>
      </tr>
    </tbody>
  </table>

  <ng-template #noUsers>
    <p class="empty">Aucun utilisateur trouvé.</p>
  </ng-template>

  <!-- Modale AJOUT / MODIFICATION -->
  <div class="modal-backdrop" *ngIf="showAddUserModal">
    <div class="modal">
      <div class="modal-header">
        <h3>{{ isEditMode ? 'Modifier un utilisateur' : 'Ajouter un utilisateur' }}</h3>
        <button class="close-btn" (click)="closeModal()">×</button>
      </div>
      <div class="modal-body">
        <label>Nom :</label>
        <input type="text" [(ngModel)]="newUser.username" placeholder="Nom complet" required>

        <label>Email :</label>
        <input type="email" [(ngModel)]="newUser.email" placeholder="Adresse email" required>

        <label>Mot de passe :</label>
        <input type="password" [(ngModel)]="newUser.password" placeholder="Mot de passe" [required]="!isEditMode">

        <label>Rôle :</label>
        <select [(ngModel)]="newUser.role" required>
          <option value="">-- Sélectionner --</option>
          <option value="user">Utilisateur</option>
          <option value="admin">Admin</option>
          <option value="approver">Approver</option>
          <option value="rh">RH</option>
          <option value="daf">DAF</option>
          <option value="caissier">Caissier</option>
        </select>

        <!-- ✅ Affichage conditionnel de l'upload d'image -->
        <div *ngIf="newUser.role === 'rh' || newUser.role === 'daf'">
            <label>Signature (scannée) :</label>
            <input type="file" (change)="onFileSelected($event)" accept="image/png, image/jpeg">
            <div *ngIf="signatureImageUrl" class="image-preview">
                <img [src]="signatureImageUrl" alt="Aperçu de la signature" style="max-width: 150px; border: 1px solid #ccc; margin-top: 10px;">
            </div>
        </div>

        <label>Journaux :</label>
        <div class="checkbox-group">
          <div *ngFor="let journal of journals">
            <input type="checkbox"
                   [checked]="newUser.journalIds.includes(journal.id_journal)"
                   (change)="onJournalChange($event, journal.id_journal)">
            {{ journal.nom_journal }}
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeModal()">Annuler</button>
        <button class="btn-primary" (click)="createOrUpdateUser()">
          {{ isEditMode ? 'Mettre à jour' : 'Enregistrer' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Modale CONFIRMATION SUPPRESSION -->
  <div class="modal-backdrop" *ngIf="showConfirmDeleteModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Confirmation</h3>
        <button class="close-btn" (click)="closeConfirmModal()">×</button>
      </div>
      <div class="modal-body">
        Êtes-vous sûr de vouloir supprimer l'utilisateur "{{ selectedUser?.username }}" ?
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeConfirmModal()">Annuler</button>
        <button class="btn-primary" (click)="deleteUser()">Supprimer</button>
      </div>
    </div>
  </div>

</div>
