<div class="form-background">
  <div class="form-container">
    <h1 class="form-title">Formulaire de Demande</h1>

    <form [formGroup]="demandeForm" (ngSubmit)="onSubmit()" class="form">
      <div class="form-grid">
        <div class="form-group">
          <label for="type" class="form-label">Type de demande</label>
          <select id="type" formControlName="type" class="form-input">
            <option value="DED">DED</option>
            <option value="Recette">Recette</option>
            <option value="ERD">ERD</option>
          </select>
        </div>

        <div class="form-group">
          <label for="date" class="form-label" [class.text-red-500]="isInvalid('date')">Date de la demande</label>
          <input type="datetime-local" id="date" formControlName="date" [class.invalid]="isInvalid('date')" class="form-input" />
          <div *ngIf="isInvalid('date')" class="form-error">La date est requise.</div>
        </div>

        <div class="form-group">
          <label for="journal" class="form-label" [class.text-red-500]="isInvalid('journal_id')">Journal</label>
          <select id="journal" formControlName="journal_id" [class.invalid]="isInvalid('journal_id')" class="form-input">
            <option [ngValue]="null" disabled>Sélectionner un journal</option>
            <option *ngFor="let j of journals" [ngValue]="j.id_journal">{{ j.nom_journal }}</option>
          </select>
          <div *ngIf="isInvalid('journal_id')" class="form-error">Le journal est requis.</div>
        </div>

        <div class="form-group">
          <label for="motif" class="form-label" [class.text-red-500]="isInvalid('description')">Motif</label>
          <input type="text" id="motif" formControlName="description" [class.invalid]="isInvalid('description')" class="form-input" />
          <div *ngIf="isInvalid('description')" class="form-error">Le motif est requis.</div>
        </div>

        <div class="form-group">
          <label for="respPj" class="form-label" [class.text-red-500]="isInvalid('resp_pj_id')">Responsable PJ</label>
          <select id="respPj" formControlName="resp_pj_id" [class.invalid]="isInvalid('resp_pj_id')" class="form-input">
            <option [ngValue]="null" disabled>Sélectionner un responsable</option>
            <option *ngFor="let p of personnes" [ngValue]="p.id">{{ p.nom }}</option>
          </select>
          <div *ngIf="isInvalid('resp_pj_id')" class="form-error">Le responsable est requis.</div>
        </div>

        <div class="form-group">
          <label for="pjStatus" class="form-label" [class.text-red-500]="isInvalid('pj_status')">Pièce justificative</label>
          <select id="pjStatus" formControlName="pj_status" class="form-input">
            <option value="oui">Oui</option>
            <option value="pas encore">Pas encore</option>
          </select>
        </div>

        <div *ngIf="demandeForm.get('pj_status')?.value === 'pas encore'" class="form-group">
          <label for="datePj" class="form-label" [class.text-red-500]="isInvalid('expected_justification_date')">Date prévue pour la PJ</label>
          <input type="date" id="datePj" formControlName="expected_justification_date" [class.invalid]="isInvalid('expected_justification_date')" class="form-input" />
          <div *ngIf="isInvalid('expected_justification_date')" class="form-error">La date est requise.</div>
        </div>
        
        <div *ngIf="demandeForm.get('type')?.value === 'ERD' && demandeForm.get('dedId')?.value" class="form-group">
          <label for="dedId" class="form-label">ID DED d'origine</label>
          <input type="text" id="dedId" formControlName="dedId" class="form-input-disabled" readonly />
        </div>
      </div>

      <div class="details-section">
        <h2 class="details-title">Détails de la demande</h2>
        <div formArrayName="details" class="details-list">
          <div *ngFor="let detail of details.controls; let i = index" [formGroupName]="i" class="detail-item">
            <div class="detail-header">
              <h3 class="detail-title" [class.text-red-500]="details.controls[i].invalid">Détail {{ i + 1 }}</h3>
              <button type="button" (click)="removeDetail(i)" class="btn-remove-detail" aria-label="Supprimer ce détail">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon-remove" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.013 21H7.987a2 2 0 01-1.92-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
            </div>

            <div class="form-group">
              <label [for]="'nature-' + i" class="form-label" [class.text-red-500]="isDetailInvalid(i, 'nature')">Nature</label>
              <select [id]="'nature-' + i" formControlName="nature" [class.invalid]="isDetailInvalid(i, 'nature')" class="form-input">
                <option [ngValue]="null" disabled>Sélectionner la nature</option>
                <option value="appro">Appro</option>
                <option value="charge">Charge</option>
                <option value="produits">Produits</option>
                <option value="autre">Autre</option>
              </select>
              <div *ngIf="isDetailInvalid(i, 'nature')" class="form-error">La nature est requise.</div>
            </div>

            <div class="form-group">
              <label [for]="'beneficiaire-' + i" class="form-label" [class.text-red-500]="isDetailInvalid(i, 'beneficiaire')">Bénéficiaire</label>
              <input type="text" [id]="'beneficiaire-' + i" formControlName="beneficiaire" [class.invalid]="isDetailInvalid(i, 'beneficiaire')" class="form-input" />
              <div *ngIf="isDetailInvalid(i, 'beneficiaire')" class="form-error">Le bénéficiaire est requis.</div>
            </div>

            <div class="form-group">
              <label class="form-label">NIF existe ?</label>
              <select formControlName="nif_exists" class="form-input">
                <option value="oui">Oui</option>
                <option value="non">Non</option>
              </select>
            </div>

            <div class="form-group" *ngIf="detail.get('nif_exists')?.value === 'oui'">
              <label [for]="'nif-' + i" class="form-label" [class.text-red-500]="isDetailInvalid(i, 'nif')">NIF</label>
              <input type="text" [id]="'nif-' + i" formControlName="nif" [class.invalid]="isDetailInvalid(i, 'nif')" class="form-input" />
              <div *ngIf="isDetailInvalid(i, 'nif')" class="form-error">Le NIF est requis.</div>
            </div>

            <div class="form-group" *ngIf="detail.get('nif_exists')?.value === 'oui'">
              <label [for]="'stat-' + i" class="form-label" [class.text-red-500]="isDetailInvalid(i, 'stat')">STAT</label>
              <input type="text" [id]="'stat-' + i" formControlName="stat" [class.invalid]="isDetailInvalid(i, 'stat')" class="form-input" />
              <div *ngIf="isDetailInvalid(i, 'stat')" class="form-error">Le STAT est requis.</div>
            </div>

            <div class="form-group">
              <label [for]="'libelle-' + i" class="form-label" [class.text-red-500]="isDetailInvalid(i, 'libelle')">Libellé</label>
              <input type="text" [id]="'libelle-' + i" formControlName="libelle" [class.invalid]="isDetailInvalid(i, 'libelle')" class="form-input" />
              <div *ngIf="isDetailInvalid(i, 'libelle')" class="form-error">Le libellé est requis.</div>
            </div>

            <div class="form-group">
              <label [for]="'amount-' + i" class="form-label" [class.text-red-500]="isDetailInvalid(i, 'amount')">Montant</label>
              <input type="number" [id]="'amount-' + i" formControlName="amount" min="0" step="0.01" [class.invalid]="isDetailInvalid(i, 'amount')" class="form-input" />
              <div *ngIf="isDetailInvalid(i, 'amount')" class="form-error">Le montant doit être supérieur à 0.</div>
            </div>

            <ng-container *ngIf="(demandeForm.get('type')?.value !== 'ERD' || i > 0)">
              <div class="form-group" *ngIf="detail.get('nature')?.value === 'charge' || detail.get('nature')?.value === 'produits'">
                <label [for]="'codeBudget-' + i" class="form-label" [class.text-red-500]="isDetailInvalid(i, 'budget_id')">Code Budget</label>
                <select [id]="'codeBudget-' + i" formControlName="budget_id" [class.invalid]="isDetailInvalid(i, 'budget_id')" class="form-input">
                  <option [ngValue]="null" disabled>Sélectionner un code budget</option>
                  <option *ngFor="let b of budgetsParJournal" [ngValue]="b.id_budget">{{ b.code_budget }} - {{ b.description }}</option>
                </select>
                <div *ngIf="isDetailInvalid(i, 'budget_id')" class="form-error">Le code budget est requis.</div>
              </div>

              <div class="form-group" *ngIf="detail.get('nature')?.value === 'charge' || detail.get('nature')?.value === 'produits'">
                <label class="form-label">Budget Annuel</label>
                <input type="number" formControlName="annual_budget" [disabled]="true" class="form-input" />
              </div>

              <div class="form-group" *ngIf="detail.get('nature')?.value === 'charge' || detail.get('nature')?.value === 'produits'">
                <label class="form-label">Budget Trimestre 1</label>
                <input type="number" formControlName="quarterly_budget" [disabled]="true" class="form-input" />
              </div>
            </ng-container>
            <div class="form-group">
              <label [for]="'numeroCompte-' + i" class="form-label"
                     [class.text-red-500]="isDetailInvalid(i, 'numero_compte')">
                Numéro de compte
              </label>
              <input type="text" [id]="'numeroCompte-' + i" formControlName="numero_compte"
                     [class.invalid]="isDetailInvalid(i, 'numero_compte')" class="form-input" />
              <div *ngIf="isDetailInvalid(i, 'numero_compte')" class="form-error">
                Le numéro de compte est requis.
              </div>
            </div>
          </div>
        </div>
        <button type="button" (click)="addDetail()" class="btn-add-detail">
          Ajouter un détail
        </button>
      </div>

      <div class="form-footer">
        <span class="total-amount">Montant Total: {{ totalAmount | number:'1.2-2' }} Ariary</span>
        <button type="submit" class="btn-submit">Soumettre la demande</button>
      </div>
    </form>
  </div>

  <div *ngIf="showModal" class="modal-overlay">
    <div class="modal-content" [ngClass]="{'modal-success': successMessage, 'modal-error': errorMessage}">
      <div class="modal-header">
        <h2 class="modal-title">{{ successMessage ? 'Succès !' : 'Erreur' }}</h2>
        <button type="button" class="modal-close" (click)="closeModal()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
            <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 011.06 0L12 10.94l5.47-5.47a.75.75 0 111.06 1.06L13.06 12l5.47 5.47a.75.75 0 11-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 01-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 010-1.06z" clip-rule="evenodd" />
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <p class="modal-message">{{ successMessage || errorMessage }}</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-modal" (click)="closeModal()">Fermer</button>
      </div>
    </div>
  </div>
</div>