<div class="flex-container">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="header-container">
      <img src="/images/salafan.jpg" alt="Logo SALFA" class="header-logo">
      <h6 class="header-title">Sampan'Asa Loterana momba ny FAhasalamana</h6>
    </div>

    <nav>
      <a role="button" [class.active]="activePage === 'Dashboard'" (click)="setActivePage('Dashboard')">
        <i class="fas fa-chart-line"></i>
        <span class="hidden-mobile">Tableau de Bord</span>
      </a>
      <a role="button" *ngIf="user?.role === 'daf'" [class.active]="activePage === 'demandesATraiter'" (click)="setActivePage('demandesATraiter')">
        <i class="fas fa-tasks"></i>
        <span class="hidden-mobile">Demandes √† traiter</span>
      </a>
      <a role="button" [class.active]="activePage === 'demandesEnAttente'" (click)="setActivePage('demandesEnAttente')">
        <i class="fas fa-hourglass-half"></i>
        <span class="hidden-mobile">Demandes en attente</span>
      </a>
      <a role="button" [class.active]="activePage === 'demandesFinalisees'" (click)="setActivePage('demandesFinalisees')">
        <i class="fas fa-check-circle"></i>
        <span class="hidden-mobile">Demandes finalis√©es</span>
      </a>
      <a role="button" [class.active]="activePage === 'rapports'" (click)="setActivePage('rapports')">
        <i class="fas fa-chart-bar"></i>
        <span class="hidden-mobile">Rapports</span>
      </a>
      <a role="button" [class.active]="activePage === 'Profil'" (click)="setActivePage('Profil')">
        <i class="fas fa-user-circle"></i>
        <span class="hidden-mobile">Mon profil</span>
      </a>
      <a role="button" (click)="logout()">
        <i class="fas fa-sign-out-alt"></i>
        <span class="hidden-mobile">D√©connexion</span>
      </a>
    </nav>
  </aside>

  <!-- Contenu -->
  <main class="main-content">
    <div class="card">
      <div *ngIf="activePage === 'Dashboard'">
        <div class="dashboard-header">
          <h1>üìä Tableau de Bord DAF</h1>
          <div class="last-update">Derni√®re mise √† jour: {{ lastUpdate | date:'dd/MM/yyyy HH:mm' }}</div>
        </div>

        <!-- Statistiques principales -->
        <div class="stats-grid">
          <div class="stat-card success">
            <div class="stat-icon"><i class="fas fa-tasks"></i></div>
            <div class="stat-content">
              <h3>Demandes √† traiter</h3>
              <p class="stat-number">{{ demandesATraiter.length }}</p>
              <div class="stat-actions">
                <button class="action-btn" (click)="setActivePage('demandesATraiter')">
                  <i class="fas fa-cog"></i> G√©rer
                </button>
              </div>
            </div>
          </div>

          <div class="stat-card warning">
            <div class="stat-icon"><i class="fas fa-hourglass-half"></i></div>
            <div class="stat-content">
              <h3>Demandes en attente</h3>
              <p class="stat-number">{{ demandesEnAttente.length }}</p>
              <div class="stat-actions">
                <button class="action-btn" (click)="setActivePage('demandesEnAttente')">
                  <i class="fas fa-cog"></i> G√©rer
                </button>
              </div>
            </div>
          </div>

          <div class="stat-card info">
            <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
            <div class="stat-content">
              <h3>Demandes finalis√©es</h3>
              <p class="stat-number">{{ demandesFinalisees.length }}</p>
              <div class="stat-actions">
                <button class="action-btn" (click)="setActivePage('demandesFinalisees')">
                  <i class="fas fa-cog"></i> G√©rer
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- R√©sum√© des activit√©s r√©centes -->
        <div class="summary-section">
          <div class="summary-card">
            <h3>Activit√©s R√©centes</h3>
            <div class="activities-list">
              <div class="activity-item" *ngFor="let activity of recentActivities">
                <div class="activity-icon" [ngClass]="activity.type">
                  <i [class]="activity.icon"></i>
                </div>
                <div class="activity-content">
                  <p class="activity-text">{{ activity.text }}</p>
                  <span class="activity-time">{{ activity.time }}</span>
                </div>
              </div>
            </div>
          </div>

          <div class="summary-card">
            <h3>Statut du Syst√®me</h3>
            <div class="system-status">
              <div class="status-item">
                <span class="status-label">Base de donn√©es</span>
                <span class="status-indicator connected"></span>
                <span class="status-text">Connect√©e</span>
              </div>
              <div class="status-item">
                <span class="status-label">Services API</span>
                <span class="status-indicator connected"></span>
                <span class="status-text">Op√©rationnels</span>
              </div>
              <div class="status-item">
                <span class="status-label">S√©curit√©</span>
                <span class="status-indicator connected"></span>
                <span class="status-text">Active</span>
              </div>
              <div class="status-item">
                <span class="status-label">Sauvegarde</span>
                <span class="status-indicator warning"></span>
                <span class="status-text">Planifi√©e</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Demandes √† Traiter -->
      <div *ngIf="activePage === 'demandesATraiter'">
        <h2 class="page-title">Demandes √† traiter (DAF)</h2>
        <div class="filters-container" *ngIf="!loadingATraiter">
          <input type="text" placeholder="Rechercher..." [(ngModel)]="searchTerm" (input)="onSearch()">
          <select [(ngModel)]="filters.type" (change)="onSearch()">
            <option value="">Tous types</option>
            <option value="Achat">Achat</option>
            <option value="Service">Service</option>
          </select>
          <select [(ngModel)]="filters.statut" (change)="onSearch()">
            <option value="">Tous statuts</option>
            <option value="en attente">En attente</option>
            <option value="approuv√©e">Approuv√©e</option>
            <option value="rejet√©e">Rejet√©e</option>
          </select>
          <input type="date" [(ngModel)]="filters.dateDebut" (change)="onSearch()" placeholder="Date d√©but">
          <input type="date" [(ngModel)]="filters.dateFin" (change)="onSearch()" placeholder="Date fin">
          <select [(ngModel)]="pageSize" (change)="changePageSize(pageSize)">
            <option value="5">5 par page</option>
            <option value="10">10 par page</option>
            <option value="20">20 par page</option>
          </select>
          <button (click)="resetFilters()" class="btn btn-sm secondary">R√©initialiser</button>
          <button (click)="exportToCSV()" class="btn btn-sm primary">Exporter CSV</button>
        </div>
        <p *ngIf="loadingATraiter" class="loading-text">Chargement...</p>

        <div class="table-container" *ngIf="!loadingATraiter">
          <table class="data-table">
            <thead>
              <tr>
                <th>id</th>
                <th>type</th>
                <th>demandeur</th>
                <th>motif</th>
                <th>montant total</th>
                <th>statut</th>
                <th>date de soumission</th>
                <th>validateur actuel</th>
                <th>actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngIf="demandesATraiter.length === 0">
                <td colspan="9" class="empty-message">
                  Aucune demande √† traiter.
                  <a routerLink="/demandes/new">Cr√©ez-en une nouvelle !</a>
                </td>
              </tr>

              <tr *ngFor="let demande of demandesATraiter">
                <td>{{ demande.id }}</td>
                <td>{{ demande.type }}</td>
                <td>{{ demande.responsible_pj?.nom }} {{ demande.responsible_pj?.prenom }}</td>
                <td>{{ demande.description || '‚Äî' }}</td>
                <td>{{ demande.montant_total | number:'1.2-2' }}</td>
                <td>
                  <span [ngClass]="{
                    'status-badge': true,
                    'status-pending': demande.status === 'en attente',
                    'status-approved': demande.status === 'approuv√©e',
                    'status-rejected': demande.status === 'rejet√©e'
                  }">
                    {{ demande.status }}
                  </span>
                </td>
                <td>{{ demande.date | date:'short':'':'fr' }}</td>
                <td>{{ demande.currentValidator || '‚Äî' }}</td>

                <td class="action-buttons">
                  <button class="btn btn-sm secondary" (click)="voirDetails(demande.id)">
                    <i class="fas fa-eye"></i>
                  </button>

                  <button class="btn btn-sm primary" *ngIf="demande.estTourUtilisateur" (click)="valider(demande.id)">
                    <i class="fas fa-check"></i>
                  </button>
                  <button class="btn btn-sm danger" *ngIf="demande.estTourUtilisateur" (click)="refuser(demande.id)">
                    <i class="fas fa-times"></i>
                  </button>

                  <span *ngIf="!demande.estTourUtilisateur" class="btn btn-sm disabled">
                    <i class="fas fa-lock"></i>
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Demandes en Attente -->
      <div *ngIf="activePage === 'demandesEnAttente'">
        <h2 class="page-title">Demandes en attente (DAF)</h2>
        <div class="filters-container" *ngIf="!loadingEnAttente">
          <input type="text" placeholder="Rechercher..." [(ngModel)]="searchTerm" (input)="onSearch()">
          <select [(ngModel)]="filters.type" (change)="onSearch()">
            <option value="">Tous types</option>
            <option value="Achat">Achat</option>
            <option value="Service">Service</option>
          </select>
          <select [(ngModel)]="filters.statut" (change)="onSearch()">
            <option value="">Tous statuts</option>
            <option value="en attente">En attente</option>
            <option value="approuv√©e">Approuv√©e</option>
            <option value="rejet√©e">Rejet√©e</option>
          </select>
          <input type="date" [(ngModel)]="filters.dateDebut" (change)="onSearch()" placeholder="Date d√©but">
          <input type="date" [(ngModel)]="filters.dateFin" (change)="onSearch()" placeholder="Date fin">
          <button (click)="resetFilters()" class="btn btn-sm secondary">R√©initialiser</button>
          <button (click)="exportToCSV()" class="btn btn-sm primary">Exporter CSV</button>
        </div>
        <p *ngIf="loadingEnAttente" class="loading-text">Chargement...</p>

        <div class="table-container" *ngIf="!loadingEnAttente">
          <table class="data-table">
            <thead>
              <tr>
                <th>id</th>
                <th>type</th>
                <th>demandeur</th>
                <th>motif</th>
                <th>montant total</th>
                <th>statut</th>
                <th>date de soumission</th>
                <th>validateur actuel</th>
                <th>actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngIf="demandesEnAttente.length === 0">
                <td colspan="9" class="empty-message">
                  Aucune demande en attente.
                </td>
              </tr>

              <tr *ngFor="let demande of demandesEnAttente">
                <td>{{ demande.id }}</td>
                <td>{{ demande.type }}</td>
                <td>{{ demande.responsible_pj?.nom }} {{ demande.responsible_pj?.prenom }}</td>
                <td>{{ demande.description || '‚Äî' }}</td>
                <td>{{ demande.montant_total | number:'1.2-2' }}</td>
                <td>
                  <span [ngClass]="{
                    'status-badge': true,
                    'status-pending': demande.status === 'en attente',
                    'status-approved': demande.status === 'approuv√©e',
                    'status-rejected': demande.status === 'rejet√©e'
                  }">
                    {{ demande.status }}
                  </span>
                </td>
                <td>{{ demande.date | date:'short':'':'fr' }}</td>
                <td>{{ demande.currentValidator || '‚Äî' }}</td>

                <td class="action-buttons">
                  <button class="btn btn-sm secondary" (click)="voirDetails(demande.id)">
                    <i class="fas fa-eye"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Demandes Finalis√©es -->
      <div *ngIf="activePage === 'demandesFinalisees'">
        <h2 class="page-title">Demandes finalis√©es (DAF)</h2>
        <div class="filters-container" *ngIf="!loadingFinalisees">
          <input type="text" placeholder="Rechercher..." [(ngModel)]="searchTerm" (input)="onSearch()">
          <select [(ngModel)]="filters.type" (change)="onSearch()">
            <option value="">Tous types</option>
            <option value="Achat">Achat</option>
            <option value="Service">Service</option>
          </select>
          <select [(ngModel)]="filters.statut" (change)="onSearch()">
            <option value="">Tous statuts</option>
            <option value="en attente">En attente</option>
            <option value="approuv√©e">Approuv√©e</option>
            <option value="rejet√©e">Rejet√©e</option>
          </select>
          <input type="date" [(ngModel)]="filters.dateDebut" (change)="onSearch()" placeholder="Date d√©but">
          <input type="date" [(ngModel)]="filters.dateFin" (change)="onSearch()" placeholder="Date fin">
          <button (click)="resetFilters()" class="btn btn-sm secondary">R√©initialiser</button>
          <button (click)="exportToCSV()" class="btn btn-sm primary">Exporter CSV</button>
        </div>
        <p *ngIf="loadingFinalisees" class="loading-text">Chargement...</p>

        <div class="table-container" *ngIf="!loadingFinalisees">
          <table class="data-table">
            <thead>
              <tr>
                <th>id</th>
                <th>type</th>
                <th>demandeur</th>
                <th>motif</th>
                <th>montant total</th>
                <th>statut</th>
                <th>date de soumission</th>
                <th>validateur final</th>
                <th>actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngIf="demandesFinalisees.length === 0">
                <td colspan="9" class="empty-message">
                  Aucune demande finalis√©e pour le moment.
                </td>
              </tr>

              <tr *ngFor="let demande of demandesFinalisees">
                <td>{{ demande.id }}</td>
                <td>{{ demande.type }}</td>
                <td>{{ demande.responsible_pj?.nom }} {{ demande.responsible_pj?.prenom }}</td>
                <td>{{ demande.description || '‚Äî' }}</td>
                <td>{{ demande.montant_total | number:'1.2-2' }}</td>
                <td>
                  <span [ngClass]="{
                    'status-badge': true,
                    'status-pending': demande.status === 'en attente',
                    'status-approved': demande.status === 'approuv√©e',
                    'status-rejected': demande.status === 'rejet√©e'
                  }">
                    {{ demande.status }}
                  </span>
                </td>
                <td>{{ demande.date | date:'short':'':'fr' }}</td>
                <td>{{ demande.finalValidatorName || '‚Äî' }}</td>

                <td class="action-buttons">
                  <button class="btn btn-sm secondary" (click)="voirDetails(demande.id)">
                    <i class="fas fa-eye"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Rapports -->
      <div *ngIf="activePage === 'rapports'">
        <h2 class="page-title">Rapports (DAF)</h2>
        <app-rapport-projet></app-rapport-projet>
      </div>

      <!-- Profil -->
      <div *ngIf="activePage === 'Profil' && user" class="profile-section">
        <h2 class="page-title">Mon profil</h2>
        <div class="profile-details">
          <p><strong>Nom d'utilisateur :</strong> {{ user.username }}</p>
          <p><strong>Email :</strong> {{ user.email }}</p>
          <p><strong>R√¥le :</strong> {{ getRoleDisplay(user.role) }}</p>
        </div>
        <div class="action-buttons">
          <button (click)="goToChangePassword()" class="primary-btn">
            Changer mon mot de passe
          </button>
        </div>
      </div>

    </div>
  </main>
</div>

<!-- Scroll to top -->
<button (click)="scrollToTop()" class="scroll-to-top" title="Remonter en haut">
  <i class="fas fa-arrow-up"></i>
</button>
