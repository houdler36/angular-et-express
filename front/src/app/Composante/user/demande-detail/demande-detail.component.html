<div class="interface-container">
  <div *ngIf="demande" class="demande-container">
    <!-- En-tête interface -->
    <div class="interface-header">
      <div class="header-actions">
        <button class="btn-back" routerLink="/dashboard/demandes">
          <i class="fas fa-arrow-left"></i> Retour
        </button>
        
        <button class="btn-pdf" (click)="generatePDF()">
          <i class="fas fa-file-pdf"></i> Exporter PDF
        </button>
      </div>
      
      <div class="status-badge" [ngClass]="'status-' + demande.status">
        {{ demande.status | titlecase }}
      </div>
    </div>

    <!-- Messages d'alerte -->
    <div *ngIf="errorMessage" class="alert alert-error">
      {{ errorMessage }}
      <button class="alert-close" (click)="clearMessages()">×</button>
    </div>

    <div *ngIf="successMessage" class="alert alert-success">
      {{ successMessage }}
      <button class="alert-close" (click)="clearMessages()">×</button>
    </div>

    <!-- Contenu principal -->
    <div class="demande-content" id="pdf-content">
      <!-- En-tête PDF -->
      <div class="pdf-header">
        <div class="pdf-logo">
          <img src="/images/salfa.jpg" alt="Logo Salafa" *ngIf="hasLogo">
          <div class="entreprise-info" *ngIf="!hasLogo">
            <h2>SALAFA</h2>
            <p>Adresse · Téléphone · Email</p>
          </div>
        </div>

        <div class="pdf-title">
          <h1>
            {{ demande.type === 'DED' ? "DEMANDE D'ENGAGEMENT DE DEPENSES (DED)" :
                demande.type === 'Recette' ? "DEMANDE DE RECETTE" : "DEMANDE ERD" }}
          </h1>
          <div class="pdf-reference">
            <strong>Référence:</strong> {{ getDemandeReference() }}
          </div>
        </div>
      </div>

      <!-- Informations demande -->
      <div class="demande-header">
        <div class="demande-info-grid">
          <div class="info-item">
            <label>Date:</label>
            <span>{{ demande.date | date:'dd/MM/yyyy' }}</span>
          </div>
          <div class="info-item">
            <label>Demandeur:</label>
            <span>{{ demande.responsible_pj?.prenom }} {{ demande.responsible_pj?.nom }}</span>
          </div>
          <div class="info-item" *ngIf="demande.journal">
            <label>Journal:</label>
            <span>{{ demande.journal.nom_journal }} ({{ demande.journal.nom_projet }}) - Numéro: {{ demande.numero_approuve_journal }} - ID: {{ demande.id }}</span>
          </div>
          <div class="info-item">
            <label>Pièces Jointes:</label>
            <span class="pj-badge" [ngClass]="{'pj-oui': demande.pj_status === 'oui', 'pj-non': demande.pj_status !== 'oui'}">
              {{ demande.pj_status === 'oui' ? '✓ Disponibles' : '✗ Manquantes' }}
            </span>
          </div>
          <div class="info-item full-width">
            <label>Motif:</label>
            <span class="motif-text">{{ demande.description }}</span>
          </div>
        </div>
      </div>

      <!-- Tableau des détails -->
      <div class="demande-details">
        <div class="table-container">
          <table class="details-table">
            <thead>
              <tr>
                <th width="15%">Bénéficiaire</th>
                <th width="25%">Libellé</th>
                <th width="20%">Code Budget</th>
                <th width="10%" *ngIf="canViewBudget()">NIF/STAT</th>
                <th width="10%" *ngIf="canViewBudget()">N° Compte</th>
                <th width="10%" class="text-right">Débit</th>
                <th width="10%" class="text-right">Crédit</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let detail of demande.details; let i = index">
                <td class="beneficiaire">{{ detail.beneficiaire }}</td>
                <td class="libelle">{{ detail.libelle }}</td>

                <td class="code-budget-cell">
                  <div class="budget-info">
                    <span class="budget-code">{{ detail.budget?.code_budget || '-' }}</span>
                    <span class="budget-desc" *ngIf="detail.budget">{{ detail.budget.description }}</span>
                    
                    <!-- Tooltip pour informations budget - SEULEMENT pour RH et DAF -->
                    <div *ngIf="canViewBudget() && detail.budget" 
                         class="budget-tooltip-trigger"
                         (mouseenter)="showBudgetTooltip(detail)"
                         (mouseleave)="hideBudgetTooltip()">
                      <i class="fas fa-info-circle"></i>
                      
                      <div *ngIf="showTooltip && selectedDetail === detail" 
                           class="budget-tooltip">
                        <div class="tooltip-item">
                          <span>Budget Annuel:</span>
                          <strong>{{ detail.budget.budget_annuel | number:'1.2-2' }} Ar</strong>

                        </div>
                        <div class="tooltip-item">
                          <span>Budget Trimestre:</span>
                          <strong>{{ getBudgetTrimestre(detail, demande.date) | number:'1.2-2' }} Ar</strong>
                        </div>
                        <div class="tooltip-item">
                          <span>Montant Ligne:</span>
                          <strong>{{ detail.amount | number:'1.2-2' }} Ar</strong>
                        </div>
                        <div class="tooltip-item">
                          <span>Solde Disponible:</span>
                          <strong>{{ getSoldeDisponible(detail) | number:'1.2-2' }} Ar</strong>
                        </div>
                      </div>
                    </div>
                  </div>
                </td>

                <td *ngIf="canViewBudget()" class="fiscal-info">
                  <div *ngIf="detail.nif" class="nif-stat">NIF: {{ detail.nif }}</div>
                  <div *ngIf="detail.stat" class="nif-stat">STAT: {{ detail.stat }}</div>
                </td>

                <td *ngIf="canViewBudget()" class="compte-number">
                  {{ detail.numero_compte || '-' }}
                </td>

                <td class="amount text-right">
                  <span *ngIf="demande.type === 'DED' || (demande.type === 'ERD' && i > 0)"
                        class="debit-amount">
                    {{ detail.amount | number:'1.2-2' }}
                  </span>
                  <span *ngIf="!(demande.type === 'DED' || (demande.type === 'ERD' && i > 0))" class="no-amount">
                    -
                  </span>
                </td>

                <td class="amount text-right">
                  <span *ngIf="demande.type === 'Recette' || (demande.type === 'ERD' && i === 0)"
                        class="credit-amount">
                    {{ detail.amount | number:'1.2-2' }}
                  </span>
                  <span *ngIf="!(demande.type === 'Recette' || (demande.type === 'ERD' && i === 0))" class="no-amount">
                    -
                  </span>
                </td>
              </tr>

              <!-- Ligne de séparation -->
              <tr class="separator">
                <td [attr.colspan]="canViewBudget() ? 7 : 5"></td>
              </tr>

              <!-- Totaux -->
              <tr class="totals-row">
                <td [attr.colspan]="canViewBudget() ? 5 : 3" class="text-right totals-label">
                  TOTAUX:
                </td>
                <td class="text-right total-amount">
                  <strong>{{ totalDebit | number:'1.2-2' }}</strong>
                </td>
                <td class="text-right total-amount">
                  <strong>{{ totalCredit | number:'1.2-2' }}</strong>
                </td>
              </tr>

              <!-- Solde -->
              <tr class="solde-row">
                <td [attr.colspan]="canViewBudget() ? 5 : 3" class="text-right solde-label">
                  SOLDE (Débit - Crédit):
                </td>

                <td class="text-right solde-amount" [ngClass]="{'negative': solde < 0}">
                  <strong *ngIf="solde < 0">{{ (solde * -1) | number:'1.2-2' }}</strong>
                  <span *ngIf="solde >= 0" class="no-amount">-</span>
                </td>

                <td class="text-right solde-amount" [ngClass]="{'positive': solde > 0}">
                  <strong *ngIf="solde > 0">{{ solde | number:'1.2-2' }}</strong>
                  <span *ngIf="solde <= 0" class="no-amount">-</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="montant-lettres">
          <strong>Arrêtée à la somme totale de:</strong> 
          <span class="montant-text">{{ montantEnLettres }} Ariary</span>
        </div>
      </div>

      <!-- Validateurs -->
      <div class="validators-section" >
        <h3 class="validators-title">VALIDATIONS</h3>

        <div class="validators-grid">
          <div *ngFor="let v of displayValidators" class="validator-card">
            <div *ngIf="v.user_id > 0" class="validator-content">
              <div class="validator-header">
                <h4>{{ v.user?.username || 'Validateur' }}</h4>
                <span class="validator-badge" [ngClass]="'status-' + v.statut">
                  {{ v.statut | titlecase }}
                </span>
              </div>

              <div class="validator-info">
                <p class="validator-date" *ngIf="v.date_validation">
                  Validé le {{ v.date_validation | date:'dd/MM/yyyy' }}
                </p>
                <p class="validator-pending" *ngIf="!v.date_validation">
                  En attente de validation
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Timeline de Validation -->
      <div class="timeline-section" *ngIf="validationTimeline && validationTimeline.length > 0 && !isGeneratingPDF && (demande.status === 'en attente' || demande.status === 'approuvée')">

        <div class="timeline-container">
          <div class="timeline">
            <div *ngFor="let event of validationTimeline; let i = index; trackBy: trackByEventId"
                 class="timeline-item"
                 [ngClass]="{'timeline-item--completed': event.completed, 'timeline-item--current': event.current, 'timeline-item--pending': !event.completed && !event.current}">

              <div class="timeline-marker">
                <div class="timeline-icon" [ngClass]="event.iconClass">
                  <i [class]="event.icon"></i>
                </div>
              </div>

              <div class="timeline-content">
                <div class="timeline-header">
                  <h4 class="timeline-event-title">{{ event.title }}</h4>
                  <span class="timeline-date">{{ event.date | date:'dd/MM/yyyy à HH:mm' }}</span>
                </div>

                <div class="timeline-details">
                  <p class="timeline-description">{{ event.description }}</p>
                  <div class="timeline-meta" *ngIf="event.validator">
                    <span class="timeline-validator">
                      <i class="fas fa-user"></i> {{ event.validator }}
                    </span>
                  </div>
                  <div class="timeline-comment" *ngIf="event.comment">
                    <i class="fas fa-comment"></i>
                    <span>{{ event.comment }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Boutons d'action -->
    <div class="action-buttons" *ngIf="demande.status === 'en attente'">
      <button class="btn-edit" (click)="editDemande()">
        <i class="fas fa-edit"></i> Modifier
      </button>

      <div class="validation-buttons" *ngIf="currentUserRole === 'rh' || currentUserRole === 'daf'">
        <button class="btn-approve" (click)="approveDemande()">
          <i class="fas fa-check-circle"></i> Approuver
        </button>

        <button class="btn-reject" (click)="openRejectModal()">
          <i class="fas fa-times-circle"></i> Rejeter
        </button>
      </div>
    </div>

    <!-- Composant PDF caché -->
    <app-demande-pdf #pdfComp [demande]="demande" [displayValidators]="displayValidators" [montantEnLettres]="montantEnLettres" [hasLogo]="hasLogo" [serverUrl]="serverUrl" [companyInfo]="companyInfo"></app-demande-pdf>
  </div>

  <!-- Modal de rejet -->
  <div *ngIf="showRejectModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Rejeter la demande</h3>
        <button class="modal-close" (click)="cancelReject()">×</button>
      </div>
      <div class="modal-body">
        <p>Veuillez indiquer la raison du rejet :</p>
        <textarea [(ngModel)]="rejectReason" 
                  placeholder="Raison du rejet..." 
                  rows="4"
                  class="reject-textarea"></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="cancelReject()">Annuler</button>
        <button class="btn-confirm-reject" (click)="confirmReject()">Confirmer le rejet</button>
      </div>
    </div>
  </div>

  <!-- Modal de suppression -->
  <div *ngIf="showDeleteConfirmModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Confirmer la suppression</h3>
        <button class="modal-close" (click)="cancelDelete()">×</button>
      </div>
      <div class="modal-body">
        <p>Êtes-vous sûr de vouloir supprimer cette demande ? Cette action est irréversible.</p>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="cancelDelete()">Annuler</button>
        <button class="btn-confirm-delete" (click)="confirmDelete()">Supprimer</button>
      </div>
    </div>
  </div>

  <!-- Modal d'approbation -->
  <div *ngIf="showApproveModal" class="modal-overlay">
    <div class="modal-content approve-modal">
      <div class="modal-header approve-header">
        <div class="modal-icon">
          <i class="fas fa-check-circle"></i>
        </div>
        <h3>Confirmer l'approbation</h3>
      </div>
      <div class="modal-body">
        <p class="approve-message">Êtes-vous sûr de vouloir approuver cette demande ?</p>
        <div class="approve-details">
          <div class="detail-item">
            <span class="label">Type:</span>
            <span class="value">{{ demande?.type }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Montant:</span>
            <span class="value">{{ totalDebit | number:'1.2-2' }} Ar</span>
          </div>
          <div class="detail-item">
            <span class="label">Demandeur:</span>
            <span class="value">{{ demande?.responsible_pj?.prenom }} {{ demande?.responsible_pj?.nom }}</span>
          </div>
        </div>
      </div>
      <div class="modal-footer approve-footer">
        <button class="btn-cancel-approve" (click)="cancelApprove()">Annuler</button>
        <button class="btn-confirm-approve" (click)="confirmApprove()">
          <i class="fas fa-check"></i> Approuver
        </button>
      </div>
    </div>
  </div>
</div>