<!-- rapport-projet.component.html -->
<div class="p-6 bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <div class="max-w-7xl mx-auto">
    
    <!-- HEADER -->
    <div class="text-center mb-8 fade-in">
      <h1 class="text-4xl font-bold text-gray-900 mb-2">üìä Rapports Financiers</h1>
      <p class="text-lg text-gray-600">Suivi et analyse des budgets et d√©penses par projet</p>
    </div>

    <!-- FILTRES PRINCIPAUX -->
    <div class="rapport-container fade-in">
      <h3>Recherche et Filtres</h3>
      
      <div class="filters-section">
        <div class="filter-row">
          <div class="filter-group">
            <label>Projet</label>
            <select [(ngModel)]="nomProjet" (change)="loadDemandes()" class="input-field">
              <option value="" disabled selected>-- S√©lectionnez un projet --</option>
              <option *ngFor="let p of projets" [value]="p.nom_projet">
                {{ p.nom_projet }}
              </option>
            </select>
          </div>

          <div class="filter-group">
            <label>P√©riode</label>
            <select [(ngModel)]="periode" (change)="filterByPeriode()" class="input-field">
              <option value="annee" selected>Ann√©e Compl√®te</option>
              <option value="T1">1er Trimestre</option>
              <option value="T2">2√®me Trimestre</option>
              <option value="T3">3√®me Trimestre</option>
              <option value="T4">4√®me Trimestre</option>
            </select>
          </div>

          <div class="filter-group">
            <label>Recherche</label>
            <input type="text" [(ngModel)]="searchTerm" 
                   placeholder="Rechercher dans les demandes..." 
                   class="input-field search-input">
          </div>

          <button class="btn btn-outline" (click)="exportToCSV()">
            üìÑ Exporter CSV
          </button>
        </div>
      </div>

      <!-- STATISTIQUES - CORRIG√â -->
      <div *ngIf="selectedBudget && stats.nombreDemandes > 0" class="stats-grid fade-in">
        <div class="stat-card">
          <div class="stat-value positive">{{ stats.totalMontant | number:'1.2-2' }}</div>
          <div class="stat-label">Total D√©pens√©</div>
          <div class="stat-progress">
            <div class="progress-bar" [style.width.%]="getTauxUtilisation()"></div>
          </div>
          <div class="text-sm text-gray-600 mt-1">
            {{ getTauxUtilisation() | number:'1.1-1' }}% du budget utilis√©
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-value">{{ stats.nombreDemandes }}</div>
          <div class="stat-label">Nombre de Demandes</div>
        </div>

        <div class="stat-card">
          <div class="stat-value">{{ getSelectedBudget() | number:'1.2-2' }}</div>
          <div class="stat-label">Budget Allou√©</div>
        </div>

        <div class="stat-card">
          <div class="stat-value" [class.positive]="getSelectedResteBudget() >= 0" 
                                [class.negative]="getSelectedResteBudget() < 0">
            {{ getSelectedResteBudget() | number:'1.2-2' }}
          </div>
          <div class="stat-label">Reste Budget</div>
        </div>
      </div>

      <!-- TABLEAU DES BUDGETS - CORRIG√â -->
      <div *ngIf="projets.length > 0 && nomProjet" class="table-container slide-in">
        <table>
          <thead>
            <tr>
              <th>Projet</th>
              <th>Code Budget</th>
              <th>Description</th>
              <th>Budget Allou√©</th>
              <th>Reste Budget</th>
              <th>Statut</th>
            </tr>
          </thead>
          <tbody>
            <ng-container *ngFor="let projet of projets">
              <ng-container *ngIf="projet.nom_projet === nomProjet">
                <tr *ngFor="let b of projet.budgets" 
                    class="cursor-pointer hover:bg-blue-50 transition-colors"
                    (click)="loadDemandesByProjetAndBudget(projet.nom_projet, b.code_budget)"
                    [class.bg-blue-50]="selectedBudget?.code_budget === b.code_budget">
                  
                  <td class="font-semibold">{{ projet.nom_projet }}</td>
                  <td class="text-blue-600 font-mono">{{ b.code_budget }}</td>
                  <td>{{ b.description }}</td>
                  
                  <td class="font-semibold">
                    {{ getBudgetForPeriod(b) | number:'1.2-2' }}
                  </td>
                  
                  <td [class.text-green-600]="getResteBudgetForPeriod(b) >= 0"
                      [class.text-red-600]="getResteBudgetForPeriod(b) < 0"
                      class="font-bold">
                    {{ getResteBudgetForPeriod(b) | number:'1.2-2' }}
                  </td>
                  
                  <td>
                    <span class="px-2 py-1 rounded-full text-xs font-semibold"
                          [class.bg-green-100]="getResteBudgetForPeriod(b) >= 0"
                          [class.text-green-800]="getResteBudgetForPeriod(b) >= 0"
                          [class.bg-red-100]="getResteBudgetForPeriod(b) < 0"
                          [class.text-red-800]="getResteBudgetForPeriod(b) < 0">
                      {{ getResteBudgetForPeriod(b) >= 0 ? '‚úÖ Sain' : '‚ö†Ô∏è D√©pass√©' }}
                    </span>
                  </td>
                </tr>
              </ng-container>
            </ng-container>
          </tbody>
        </table>
      </div>

      <!-- MESSAGES D'√âTAT -->
      <div *ngIf="loading" class="text-center py-8">
        <div class="loading-spinner mx-auto mb-4"></div>
        <p class="text-gray-600">Chargement des donn√©es...</p>
      </div>

      <div *ngIf="errorMessage" class="alert alert-error">
        ‚ö†Ô∏è {{ errorMessage }}
      </div>

      <div *ngIf="!nomProjet" class="text-center py-8">
        <div class="text-6xl mb-4">üìã</div>
        <p class="text-gray-500 text-lg">Veuillez s√©lectionner un projet pour afficher son rapport financier</p>
      </div>
    </div>

    <!-- TABLEAU DES DEMANDES -->
  <!-- TABLEAU DES DEMANDES -->
<div *ngIf="demandesFiltrees.length > 0 && !loading" class="rapport-container fade-in">
  <div class="flex justify-between items-center mb-4">
    <h3>D√©tail des Demandes</h3>
    <span class="text-sm text-gray-600">
      {{ demandesFiltrees.length }} demande(s) trouv√©e(s)
    </span>
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th class="border p-2">Code Budget</th>
          <th class="border p-2">Date Approuv√©e</th>
          <th class="border p-2">Nom Journal</th>
          <th class="border p-2">Num√©ro Journal</th>
          <th class="border p-2">ID</th>
          <th class="border p-2">Motif</th>
          <th class="border p-2">B√©n√©ficiaire</th>
          <th class="border p-2">Libell√©</th>
          <th class="border p-2">Montant</th>
          <th class="border p-2">Num√©ro Compte</th>
          <th class="border p-2">Statut</th>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngFor="let d of demandesFiltrees">
          <tr *ngFor="let detail of d.details" class="fade-in">
            <td class="border p-2">{{ detail.budget?.code_budget || '‚Äî' }}</td>
            <td class="border p-2 whitespace-nowrap">{{ d.date_approuvee | date:'dd/MM/yyyy' }}</td>
            <td class="border p-2">{{ d.journal?.nom_journal || '‚Äî' }}</td>
            <td class="border p-2">{{ d.numero_approuve_journal }}</td>
            <td class="border p-2">{{ d.id }}</td>
            <td class="border p-2">{{ d.type }}</td>
            <td class="border p-2 max-w-xs truncate">{{ detail.beneficiaire || '‚Äî' }}</td>
            <td class="border p-2 max-w-md truncate" [title]="detail.libelle">{{ detail.libelle }}</td>
            <td class="border p-2 font-semibold text-right">{{ detail.amount | number:'1.2-2' }}</td>
            <td class="border p-2 font-mono text-sm">{{ detail.numero_compte || '‚Äî' }}</td>
            <td class="border p-2">
              <span class="px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                ‚úÖ Approuv√©
              </span>
            </td>
          </tr>
        </ng-container>
      </tbody>
    </table>
  </div>
</div>

    <!-- AUCUNE DONN√âE -->
    <div *ngIf="nomProjet && demandesFiltrees.length === 0 && !loading" class="rapport-container text-center">
      <div class="text-6xl mb-4">üì≠</div>
      <h3 class="text-xl font-semibold text-gray-700 mb-2">Aucune demande trouv√©e</h3>
      <p class="text-gray-500">Aucune demande ne correspond aux crit√®res s√©lectionn√©s pour cette p√©riode.</p>
    </div>

  </div>
</div>