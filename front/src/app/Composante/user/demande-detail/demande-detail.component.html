<div *ngIf="demande" class="demande-container">
    <div class="demande-header">
      <h1 class="demande-title">
        {{ demande.type === 'DED' ? "DEMANDE D'ENGAGEMENT DE DEPENSES (DED)" :
            demande.type === 'Recette' ? "DEMANDE DE RECETTE" : "DEMANDE ERD" }}
      </h1>

      <div class="demande-info">
        <div><strong>Date:</strong> {{ demande.date | date:'shortDate' }}</div>
        <div><strong>Demandeur:</strong> {{ demande.responsible_pj?.prenom }} {{ demande.responsible_pj?.nom }}</div>
        <div><strong>PJ:</strong> {{ demande.pj_status === 'oui' ? 'Oui' : 'Non' }}</div>
      </div>

      <div class="demande-motif">
        <strong>Motif:</strong> {{ demande.description }}
      </div>
    </div>

    <div class="demande-details">
      <table>
    <thead>
      <tr>
        <th>P/J de</th>
        <th>Libellé</th>
        <th>Code Budget</th>
        <th *ngIf="currentUserRole === 'rh' || currentUserRole === 'daf'">NIF / STAT</th>
        <th *ngIf="currentUserRole === 'rh' || currentUserRole === 'daf'">N° Compte</th>
        <th>Débit</th>
        <th>Crédit</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let detail of demande.details; let i = index">
        <td>{{ detail.beneficiaire }}</td>
        <td>{{ detail.libelle }}</td>

        <td class="code-budget-cell">
          <div class="tooltip-container"
            (mouseenter)="showBudgetTooltip(detail)"
            (mouseleave)="hideBudgetTooltip()">
            
            <ng-container *ngIf="detail.budget; else noBudget">
              {{ detail.budget.code_budget }} - {{ detail.budget.description }}
            </ng-container>

            <ng-template #noBudget>
              <span>-</span>
            </ng-template>

            <div *ngIf="(currentUserRole === 'rh' || currentUserRole === 'daf') && showTooltip && selectedDetail === detail"
                class="budget-tooltip">
              <p><strong>Budget Annuel:</strong> {{ detail.budget?.budget_annuel | currency:'MGA':'symbol':'1.0-0' }}</p>
              <p><strong>Budget Trimestre:</strong> {{ getBudgetTrimestre(detail, demande.date) | currency:'MGA':'symbol':'1.0-0' }}</p>
            </div>
          </div>
        </td>

        <td *ngIf="currentUserRole === 'rh' || currentUserRole === 'daf'">
          <div *ngIf="detail.nif">NIF: {{ detail.nif }}</div>
          <div *ngIf="detail.stat">STAT: {{ detail.stat }}</div>
        </td>

        <td *ngIf="currentUserRole === 'rh' || currentUserRole === 'daf'">{{ detail.numero_compte }}</td>

        <td class="text-right">
          {{ (demande.type !== 'ERD' || i > 0) ? (detail.amount | currency:'MGA':'symbol':'1.0-0') : '-' }}
        </td>

        <td class="text-right">
          {{ (demande.type === 'ERD' && i === 0) ? (detail.amount | currency:'MGA':'symbol':'1.0-0') : '-' }}
        </td>
      </tr>

      <tr class="totals">
        <td [attr.colspan]="currentUserRole === 'rh' || currentUserRole === 'daf' ? 5 : 3" class="text-right">
          TOTAUX:
        </td>
        <td class="text-right">{{ totalDebit | currency:'MGA':'symbol':'1.0-0' }}</td>
        <td class="text-right">{{ totalCredit | currency:'MGA':'symbol':'1.0-0' }}</td>
      </tr>

      <tr class="solde">
        <td [attr.colspan]="currentUserRole === 'rh' || currentUserRole === 'daf' ? 5 : 3" class="text-right">
          SOLDE (Débit - Crédit):
        </td>
        <td colspan="2" class="text-center">{{ solde | currency:'MGA':'symbol':'1.0-0' }}</td>
      </tr>
    </tbody>
</table>
    <p class="montant-lettres">
      <strong>Arrêtée à la somme totale de:</strong> {{ montantEnLettres }} Ariary
    </p>
    </div>

    <div class="validators-section">
      <table>
        <thead>
          <tr>
            <th *ngFor="let v of displayValidators">{{ v.user?.username || 'Validateur' }}</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td *ngFor="let v of displayValidators">
              <div class="signature-container">
                <ng-container *ngIf="v.statut === 'validé' && (v.signature_validation_url || v.user?.signature_image_url); else placeholderSignature">
                  <img [src]="serverUrl + (v.signature_validation_url || v.user?.signature_image_url)"
                       alt="Signature de {{ v.user?.username }}"
                       class="signature-image"
                       (error)="handleImageError(v)">
                  <p class="validator-name">{{ v.user?.username }}</p>
                  <p class="validator-status valid">(Validé)</p>
                </ng-container>

                <ng-template #placeholderSignature>
                  <div class="signature-placeholder">
                    <i class="fas fa-signature"></i>
                  </div>
                  <p class="validator-name">{{ v.user?.username || '–' }}</p>
                  <p class="validator-status"
                     [ngClass]="{
                       'text-yellow': v.statut==='en attente',
                       'text-red': v.statut==='rejeté'
                     }">({{ v.statut | titlecase }})</p>
                </ng-template>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="action-buttons">
      <button class="btn-back" routerLink="/demandes"><i class="fas fa-arrow-left"></i> Retour</button>
      <button *ngIf="demande.status==='en attente'" class="btn-edit" (click)="editDemande()"><i class="fas fa-edit"></i> Modifier</button>
      <button *ngIf="demande.status==='en attente'" class="btn-approve" (click)="approveDemande()"><i class="fas fa-check-circle"></i> Approuver</button>
      <button *ngIf="demande.status==='en attente'" class="btn-reject" (click)="openRejectModal()"><i class="fas fa-times-circle"></i> Rejeter</button>
    </div>
</div>