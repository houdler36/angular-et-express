<!-- === Ajoute Font Awesome dans index.html === -->
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
/>

<div class="daf-dashboard">
  <!-- === SIDEBAR === -->
  <aside class="sidebar">
    <div class="header-container">
      <img src="/images/salafan.jpg" alt="Logo SALFA" class="header-logo" />
      <h6 class="header-title">
        Sampan'Asa Loterana momba ny FAhasalamana
      </h6>
    </div>

    <nav>
      <a role="button" [class.active]="activePage === 'Dashboard'" (click)="setActivePage('Dashboard')">
        <i class="fas fa-home"></i> <span class="hidden-mobile">Tableau de Bord</span>
      </a>
      <a role="button" [class.active]="activePage === 'demandesATraiter'" (click)="setActivePage('demandesATraiter')">
        <i class="fas fa-tasks"></i> <span class="hidden-mobile">Demandes à traiter</span>
      </a>
      <a role="button" [class.active]="activePage === 'demandesEnAttente'" (click)="setActivePage('demandesEnAttente')">
        <i class="fas fa-hourglass-half"></i> <span class="hidden-mobile">Demandes en attente</span>
      </a>
      <a role="button" [class.active]="activePage === 'demandesFinalisees'" (click)="setActivePage('demandesFinalisees')">
        <i class="fas fa-check-circle"></i> <span class="hidden-mobile">Demandes finalisées</span>
      </a>
      <a role="button" [class.active]="activePage === 'rapports'" (click)="setActivePage('rapports')">
        <i class="fas fa-chart-bar"></i> <span class="hidden-mobile">Rapports</span>
      </a>
    </nav>
  </aside>

  <!-- === MAIN CONTENT === -->
  <main class="main-content">
    <div class="card">

      <!-- === Dashboard === -->
      <section *ngIf="activePage === 'Dashboard'" class="content-section">
        <h1 class="page-title">Tableau de Bord DAF</h1>

        <div class="stats-grid">
          <div class="stat-card success">
            <h3>Demandes à traiter</h3>
            <p class="stat-number">{{ demandesATraiter.length }}</p>
          </div>
          <div class="stat-card warning">
            <h3>Demandes en attente</h3>
            <p class="stat-number">{{ demandesEnAttente.length }}</p>
          </div>
          <div class="stat-card info">
            <h3>Demandes finalisées</h3>
            <p class="stat-number">{{ demandesFinalisees.length }}</p>
          </div>
        </div>
      </section>

      <!-- === Demandes à traiter === -->
      <section *ngIf="activePage === 'demandesATraiter'" class="content-section">
        <h2 class="page-title">Demandes à traiter (DAF)</h2>
        <p *ngIf="loadingATraiter" class="loading-text">Chargement...</p>

        <table *ngIf="!loadingATraiter && demandesATraiter.length > 0" class="fade-in-table">
          <thead>
            <tr>
              <th>Titre</th>
              <th>Montant</th>
              <th>Status</th>
              <th>Actions</th>
              <th>Détails</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let demande of demandesATraiter">
              <td>{{ demande.description || '—' }}</td>
              <td>{{ demande.montant_total | currency:'MGA':'symbol':'1.0-0' }}</td>
              <td>{{ demande.status }}</td>
              <td>
                <button *ngIf="demande.estTourUtilisateur" (click)="valider(demande.id)" class="icon-btn success">
                  <i class="fas fa-check"></i>
                </button>
                <button *ngIf="demande.estTourUtilisateur" (click)="refuser(demande.id)" class="icon-btn danger">
                  <i class="fas fa-times"></i>
                </button>
                <span *ngIf="!demande.estTourUtilisateur" class="icon-btn disabled">
                  <i class="fas fa-lock"></i>
                </span>
              </td>
              <td>
                <button (click)="voirDetails(demande.id)" class="icon-btn info">
                  <i class="fas fa-eye"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>

        <p *ngIf="!loadingATraiter && demandesATraiter.length === 0" class="empty-message">
          Aucune demande à traiter actuellement
        </p>
      </section>

      <!-- === Demandes en attente === -->
      <section *ngIf="activePage === 'demandesEnAttente'" class="content-section">
        <h2 class="page-title">Demandes en attente (DAF)</h2>
        <p *ngIf="loadingEnAttente" class="loading-text">Chargement...</p>

        <table *ngIf="!loadingEnAttente && demandesEnAttente.length > 0" class="fade-in-table">
          <thead>
            <tr>
              <th>Titre</th>
              <th>Montant</th>
              <th>Status</th>
              <th>Validateur actuel</th>
              <th>Détails</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let demande of demandesEnAttente">
              <td>{{ demande.description || '—' }}</td>
              <td>{{ demande.montant_total | currency:'MGA':'symbol':'1.0-0' }}</td>
              <td>{{ demande.status }}</td>
              <td>{{ demande.currentValidator || '—' }}</td>
              <td>
                <button (click)="voirDetails(demande.id)" class="icon-btn info">
                  <i class="fas fa-eye"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>

        <p *ngIf="!loadingEnAttente && demandesEnAttente.length === 0" class="empty-message">
          Aucune demande en attente chez d'autres validateurs
        </p>
      </section>

      <!-- === Demandes finalisées === -->
      <section *ngIf="activePage === 'demandesFinalisees'" class="content-section">
        <h2 class="page-title">Demandes finalisées (DAF)</h2>
        <p *ngIf="loadingFinalisees" class="loading-text">Chargement...</p>

        <table *ngIf="!loadingFinalisees && demandesFinalisees.length > 0" class="fade-in-table">
          <thead>
            <tr>
              <th>Titre</th>
              <th>Montant</th>
              <th>Status</th>
              <th>Validateur final</th>
              <th>Détails</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let demande of demandesFinalisees">
              <td>{{ demande.description || '—' }}</td>
              <td>{{ demande.montant_total | currency:'MGA':'symbol':'1.0-0' }}</td>
              <td>{{ demande.status }}</td>
              <td>{{ demande.finalValidatorName || '—' }}</td>
              <td>
                <button (click)="voirDetails(demande.id)" class="icon-btn info">
                  <i class="fas fa-eye"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>

        <p *ngIf="!loadingFinalisees && demandesFinalisees.length === 0" class="empty-message">
          Aucune demande finalisée pour le moment
        </p>
      </section>

      <!-- === Rapports === -->
      <section *ngIf="activePage === 'rapports'" class="content-section">
        <h2 class="page-title">Rapports (DAF)</h2>
        <app-rapport-projet></app-rapport-projet>
      </section>

    </div>
  </main>
</div>
