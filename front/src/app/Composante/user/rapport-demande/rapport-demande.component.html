<div class="rapport-container">
  <div class="header-section">
    <h2>Rapport des demandes approuv√©es</h2>
    <p class="subtitle">Suivi financier des op√©rations approuv√©es</p>
  </div>

  <!-- Filtres am√©lior√©s -->
  <div class="filters-card">
    <h3>Filtres</h3>
    <div class="filters">
      <div class="filter-group">
        <label for="journal">S√©lectionner le journal:</label>
        <div class="select-wrapper">
          <select id="journal" [(ngModel)]="selectedJournalId">
            <option [ngValue]="null">-- Choisir un journal --</option>
            <option *ngFor="let journal of journals" [ngValue]="journal.id_journal">
              {{ journal.nom_journal }}
            </option>
          </select>
          <span class="select-arrow">‚ñº</span>
        </div>
      </div>

      <div class="filter-group">
        <label for="startDate">Date d√©but:</label>
        <div class="date-wrapper">
          <input type="date" id="startDate" [(ngModel)]="startDate">
        </div>
      </div>

      <div class="filter-group">
        <label for="endDate">Date fin:</label>
        <div class="date-wrapper">
          <input type="date" id="endDate" [(ngModel)]="endDate">
        </div>
      </div>

      <button class="btn-primary" (click)="loadRapport()" [disabled]="!selectedJournalId || !startDate || !endDate">
        <span class="btn-icon">üìä</span>
        Afficher le rapport
      </button>
    </div>
  </div>

  <!-- R√©sum√© statistique -->
  <div *ngIf="demandes.length > 0" class="stats-summary">
    <div class="stat-card">
      <div class="stat-icon">üìà</div>
      <div class="stat-info">
        <span class="stat-value">{{ demandes.length }}</span>
        <span class="stat-label">Demandes</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">üí∞</div>
      <div class="stat-info">
        <span class="stat-value">{{ formatCurrency(getTotalEncaissement()) }}</span>
        <span class="stat-label">Total Encaissements</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">üí∏</div>
      <div class="stat-info">
        <span class="stat-value">{{ formatCurrency(getTotalDecaissement()) }}</span>
        <span class="stat-label">Total D√©caissements</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">‚öñÔ∏è</div>
      <div class="stat-info">
        <span class="stat-value">{{ formatCurrency(getEtatSolde()) }}</span>
        <span class="stat-label">Solde Final</span>
      </div>
    </div>
  </div>

  <!-- Informations de solde -->
  <div *ngIf="demandes.length > 0" class="solde-section">
    <div class="solde-card">
      <div class="solde-item">
        <span class="solde-label">D√©but de solde :</span>
        <span class="solde-value positive">{{ formatCurrency(getDebutSolde()) }}</span>
      </div>
      <div class="solde-item">
        <span class="solde-label">√âtat de solde :</span>
        <span class="solde-value" [class.positive]="getEtatSolde() >= 0" [class.negative]="getEtatSolde() < 0">
          {{ formatCurrency(getEtatSolde()) }}
        </span>
      </div>
    </div>
  </div>

  <div *ngIf="loading" class="loading-container">
    <div class="loading-spinner"></div>
    <p>Chargement des donn√©es...</p>
  </div>
  
  <div *ngIf="errorMessage" class="error-message">
    <span class="error-icon">‚ö†Ô∏è</span>
    <p>{{ errorMessage }}</p>
  </div>

  <!-- Contenu PDF cach√© -->
  <div #pdfContent *ngIf="demandes.length > 0" class="pdf-content" style="position: absolute; left: -9999px; top: -9999px;">
    <div class="pdf-header">
      <div class="pdf-logo">
        <img src="/images/salafan.jpg" alt="Logo Salafa" style="max-width: 100px;">
        <div class="entreprise-info">
          <h2>SALFA</h2>
          <p>Adresse ¬∑ T√©l√©phone ¬∑ Email</p>
        </div>
      </div>
      <div class="pdf-title">
        <h1>Rapport des demandes approuv√©es</h1>
        <div class="pdf-reference">
          <strong>Journal:</strong> {{ getSelectedJournalName() }}<br>
          <strong>P√©riode:</strong> {{ formatDate(startDate) }} - {{ formatDate(endDate) }}
        </div>
      </div>
    </div>

    <div class="pdf-stats">
      <div class="stats-grid">
        <div class="stat-item">
          <span class="stat-label">Nombre de demandes:</span>
          <span class="stat-value">{{ demandes.length }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Total Encaissements:</span>
          <span class="stat-value">{{ formatCurrency(getTotalEncaissement()) }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Total D√©caissements:</span>
          <span class="stat-value">{{ formatCurrency(getTotalDecaissement()) }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Solde Final:</span>
          <span class="stat-value">{{ formatCurrency(getEtatSolde()) }}</span>
        </div>
      </div>
    </div>

    <div class="pdf-table">
      <table class="pdf-rapport-table">
        <thead>
          <tr>
            <th>Date Approuv√©</th>
            <th>ID</th>
            <th>Num√©ro Journal</th>
            <th>Motif</th>
            <th>Type</th>
            <th>Encaissement</th>
            <th>D√©caissement</th>
            <th>Solde Progressif</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let demande of demandes">
            <td>{{ formatDateTime(demande.date_approuve) }}</td>
            <td>{{ demande.id }}</td>
            <td>{{ demande.numero_journal_approuve || '-' }}</td>
            <td>{{ demande.motif || demande.description }}</td>
            <td>{{ demande.type }}</td>
            <td>{{ (demande.type === 'Recette' || (demande.type === 'ERD' && demande.montant_total >= 0)) ? formatCurrency(getAbsoluteValue(demande.montant_total)) : '-' }}</td>
            <td>{{ demande.type === 'DED' || (demande.type === 'ERD' && demande.montant_total < 0) ? formatCurrency(getAbsoluteValue(demande.montant_total)) : '-' }}</td>
            <td>{{ formatCurrency(demande.soldeProgressif) }}</td>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <th colspan="5" class="text-center">Totaux</th>
            <th>{{ formatCurrency(getTotalEncaissement()) }}</th>
            <th>{{ formatCurrency(getTotalDecaissement()) }}</th>
            <th></th>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="pdf-footer">
      <p>Rapport g√©n√©r√© le {{ getCurrentDateFormatted() }}</p>
    </div>
  </div>

  <!-- Tableau des demandes -->
  <div *ngIf="demandes.length > 0" class="table-container">
    <div class="table-header">
      <h3>D√©tail des op√©rations</h3>
      <div class="export-buttons">
        <button class="btn-export" (click)="exportToExcel()">
          <span class="btn-icon">üìä</span>
          Excel
        </button>
        <button class="btn-export btn-pdf" (click)="exportToPDF()">
          <span class="btn-icon">üìÑ</span>
          PDF
        </button>
      </div>
    </div>

    <div class="table-scroll">
      <table class="rapport-table">
        <thead>
          <tr>
            <th class="sortable" (click)="sortBy('date_approuve')">
              Date Approuv√©
              <span class="sort-indicator" *ngIf="sortField === 'date_approuve'">
                {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
            </th>
            <th class="sortable" (click)="sortBy('id')">
              ID
              <span class="sort-indicator" *ngIf="sortField === 'id'">
                {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
            </th>
            <th>Num√©ro Journal</th>
            <th class="sortable" (click)="sortBy('motif')">
              Motif
              <span class="sort-indicator" *ngIf="sortField === 'motif'">
                {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
            </th>
            <th class="sortable text-right" (click)="sortBy('type')">
              Type
              <span class="sort-indicator" *ngIf="sortField === 'type'">
                {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
            </th>
            <th class="text-right">Encaissement</th>
            <th class="text-right">D√©caissement</th>
            <th class="text-right sortable" (click)="sortBy('soldeProgressif')">
              Solde Progressif
              <span class="sort-indicator" *ngIf="sortField === 'soldeProgressif'">
                {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let demande of demandes; let i = index" [class.even-row]="i % 2 === 0">
            <td>{{ formatDateTime(demande.date_approuve) }}</td>
            <td class="id-cell">{{ demande.id }}</td>
            <td>
              <span class="journal-badge">{{ demande.numero_journal_approuve || '-' }}</span>
            </td>
            <td class="motif-cell">{{ demande.motif || demande.description }}</td>
            <td class="text-right">
              <span class="type-badge" [class.recette]="demande.type === 'Recette' || demande.type === 'ERD'" 
                    [class.depense]="demande.type === 'DED'">
                {{ demande.type }}
              </span>
            </td>
            <td class="text-right encaissement">
              {{ (demande.type === 'Recette' || (demande.type === 'ERD' && demande.montant_total >= 0)) ? formatCurrency(getAbsoluteValue(demande.montant_total)) : '-' }}
            </td>
            <td class="text-right decaissement">
              {{ demande.type === 'DED' || (demande.type === 'ERD' && demande.montant_total < 0) ? formatCurrency(getAbsoluteValue(demande.montant_total)) : '-' }}
            </td>
            <td class="text-right solde" [class.negative]="demande.soldeProgressif < 0">
              {{ formatCurrency(demande.soldeProgressif) }}
            </td>
          </tr>
        </tbody>

        <!-- Pied de tableau avec les totaux -->
        <tfoot>
          <tr>
            <th colspan="5" class="text-right">Totaux</th>
            <th class="text-right total-encaissement">{{ formatCurrency(getTotalEncaissement()) }}</th>
            <th class="text-right total-decaissement">{{ formatCurrency(getTotalDecaissement()) }}</th>
            <th></th>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <!-- Aucune donn√©e -->
  <div *ngIf="demandes.length === 0 && !loading && !errorMessage" class="no-data">
    <div class="no-data-icon">üìã</div>
    <h3>Aucune demande approuv√©e</h3>
    <p>Aucune donn√©e n'est disponible pour ce journal et cette p√©riode.</p>
  </div>
</div>