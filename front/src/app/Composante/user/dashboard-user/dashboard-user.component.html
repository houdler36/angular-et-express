<div class="dashboard-wrapper">

  <aside class="sidebar">

    <div class="sidebar-header">
      <img src="images/salafan.jpg" alt="Logo SALFA" class="sidebar-logo">
      <h6 class="sidebar-title">Sampan'Asa Loterana momba ny FAhasalamana</h6>
    </div>

    <nav class="sidebar-nav">
      <a (click)="toggleNewDemandeForm(false)" class="nav-item" 
         [class.active]="!showNewDemandeForm && !showDemandeList && !showDemandeRecap && !showRapportDemande && !showProfile">
        <i class="fas fa-chart-line"></i>
        <span>Tableau de bord</span>
      </a>

      <a (click)="toggleNewDemandeForm(true)" class="nav-item" [class.active]="showNewDemandeForm">
        <i class="fas fa-plus-circle"></i>
        <span>Nouvelle demande</span>
      </a>

      <a (click)="toggleDemandeList(true)" class="nav-item" [class.active]="showDemandeList">
        <i class="fas fa-list"></i>
        <span>Liste des demandes</span>
      </a>

      <a (click)="toggleDemandeRecap(true)" class="nav-item" [class.active]="showDemandeRecap">
        <i class="fas fa-chart-pie"></i>
        <span>Récapitulatif des dépenses</span>
      </a>

      <a (click)="toggleRapportDemande(true)" class="nav-item" [class.active]="showRapportDemande">
        <i class="fas fa-file-alt"></i>
        <span>Rapport des demandes</span>
      </a>

      <a (click)="toggleProfile(true)" class="nav-item" [class.active]="showProfile">
        <i class="fas fa-user"></i>
        <span>Mon Profil</span>
      </a>
    </nav>

  </aside>

  <div class="main-content">

    <!-- Tableau de bord -->
    <div *ngIf="!showNewDemandeForm && !showDemandeList && !showDemandeRecap && !showRapportDemande && !showProfile">
      <div class="dashboard-header">
        <h2><i class="fas fa-chart-line"></i> Bienvenue sur votre Tableau de Bord</h2>
        <p>Accédez rapidement à vos statistiques et actions principales.</p>
      </div>

      <div class="dashboard-stats">
        <div class="stat-card total">
          <i class="fas fa-folder-open icon"></i>
          <h3>Total des demandes</h3>
          <p class="stat-value">{{ totalDemandes }}</p>
        </div>
        <div class="stat-card pending">
          <i class="fas fa-hourglass-half icon"></i>
          <h3>En attente</h3>
          <p class="stat-value">{{ demandesEnAttente }}</p>
        </div>
        <div class="stat-card approved">
          <i class="fas fa-check-circle icon"></i>
          <h3>Approuvées</h3>
          <p class="stat-value">{{ demandesApprouvees }}</p>
        </div>
        <div class="stat-card rejected">
          <i class="fas fa-times-circle icon"></i>
          <h3>Rejetées</h3>
          <p class="stat-value">{{ demandesRejetees }}</p>
        </div>
      </div>

      <div class="dashboard-actions">
        <button class="btn primary" (click)="toggleNewDemandeForm(true)">
          <i class="fas fa-plus-circle"></i> Nouvelle Demande
        </button>
        <button class="btn secondary" (click)="toggleDemandeList(true)">
          <i class="fas fa-list"></i> Voir toutes mes demandes
        </button>
      </div>
          <h3 class="section-title"><i class="fas fa-history"></i> Vos dernières demandes</h3>

      <div class="search-container">
        <i class="fas fa-search search-icon"></i>
        <input type="text" [(ngModel)]="searchTerm" (input)="applyFilter()" placeholder="Rechercher par type, montant, statut ou date...">
      </div>

      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>id</th> 
              <th>Type</th>
           <th>demandeur</th>
              <th>Montant</th>
              <th>Statut</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="lastDemandes.length === 0 && !errorMessage">
              <td colspan="5">Aucune demande récente à afficher.</td>
            </tr>
            <tr *ngFor="let demande of lastDemandes">
              <td>{{ demande.id }}</td>
          <td>{{ demande.type }}</td>
          <td>{{ demande.responsible_pj?.nom }} {{ demande.responsible_pj?.prenom }}</td>
              <td>{{ demande.montant_total }}</td>
              <td>
                <span [ngClass]="{
                  'status-badge': true,
                  'status-pending': demande.status === 'En attente',
                  'status-approved': demande.status === 'Approuvée',
                  'status-rejected': demande.status === 'Rejetée'
                }">
                  {{ demande.status }}
                </span>
              </td>
              <td>{{ demande.date | date: 'dd-MM-yyyy' }}</td>
              <td>
                <button class="btn btn-sm secondary" (click)="goToDemande(demande.id)">
                  <i class="fas fa-eye"></i> Voir
                </button>
              </td>
            </tr>
            <tr *ngIf="errorMessage">
              <td colspan="5" class="text-center text-danger">Erreur : {{ errorMessage }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    

    <!-- Nouvelle demande -->
    <div *ngIf="showNewDemandeForm">
      <app-demande-form
        (formSubmitted)="onFormSubmitted()"
        (formCanceled)="toggleNewDemandeForm(false)">
      </app-demande-form>
    </div>

    <!-- Liste des demandes -->
    <div *ngIf="showDemandeList">
      <app-demande-list></app-demande-list>
    </div>

    <!-- Récapitulatif des dépenses -->
    <div *ngIf="showDemandeRecap">
      <app-demande-recap></app-demande-recap>
    </div>

    <!-- Rapport des demandes -->
    <div *ngIf="showRapportDemande">
      <app-rapport-demande></app-rapport-demande>
    </div>

    <!-- Profil utilisateur -->
    <div *ngIf="showProfile" class="profile-container">
      <h2>Modifier mon profil</h2>

      <form (ngSubmit)="updateProfile()" #profileForm="ngForm">

        <!--div class="form-group">
          <label for="username">Nom d'utilisateur</label>
          <input type="text" id="username" [(ngModel)]="currentUser.username" name="username" required>
        </div-->

       <div class="form-group">
  <label for="currentPassword">Mot de passe actuel</label>
  <input type="password" id="currentPassword" [(ngModel)]="currentPassword" name="currentPassword">
</div>

<div class="form-group">
  <label for="newPassword">Nouveau mot de passe</label>
  <input type="password" id="newPassword" [(ngModel)]="newPassword" name="newPassword">
</div>

<div class="form-group">
  <label for="confirmPassword">Confirmer le nouveau mot de passe</label>
  <input type="password" id="confirmPassword" [(ngModel)]="confirmPassword" name="confirmPassword">
</div>

        <button type="submit" class="btn primary">Enregistrer</button>
        <button type="button" class="btn secondary" (click)="toggleProfile(false)">Annuler</button>

      </form>

      <div *ngIf="profileMessage" class="profile-message">{{ profileMessage }}</div>
    </div>

  </div>
</div>
